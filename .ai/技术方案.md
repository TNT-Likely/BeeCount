# 🐝 蜜蜂记账

## 技术架构方案文档

> 一款基于 Flutter 的开源记账软件，支持 iOS 与 Android 双端，采用 SQLite 本地存储，设计可插拔式云同步接口，支持未来灵活接入多种免费云服务（如 GitHub、Firebase、Supabase、OneDrive 等），具备高可维护性与扩展性。

---

## 1. 项目目标

- 实现一款**完全免费、开源、无广告**的记账工具。
- 支持 **iOS 与 Android 双端原生体验**。
- 数据**默认本地存储**，保障用户隐私。
- **预留云同步能力**，支持未来接入多种免费云服务。
- 架构设计**可插拔、可替换**，避免对单一云服务产生依赖。
- 代码结构清晰，便于社区贡献与长期维护。

---

## 2. 技术栈选型

| 类别 | 技术 | 选型理由 |
|------|------|----------|
| **跨平台框架** | Flutter | 高性能、跨平台一致性好、生态成熟、支持 iOS/Android/Web |
| **编程语言** | Dart | 与 Flutter 深度集成，空安全、现代语法、开发效率高 |
| **本地数据库** | SQLite（通过 `drift` 封装） | 轻量、可靠、本地嵌入式，适合单用户应用 |
| **状态管理** | Riverpod | 响应式、可测试、解耦性强，适合中大型应用 |
| **网络请求** | `dio` | 功能丰富，支持拦截器、日志、超时、错误处理 |
| **JSON 序列化** | `json_annotation` + `json_serializable` | 编译时生成，类型安全，性能高 |
| **依赖注入** | 构造函数依赖注入 | 简洁清晰，避免复杂容器，便于测试 |
| **构建与发布** | Fastlane + GitHub Actions | 自动化构建、签名、发布到 App Store / Google Play |
| **文档与协作** | GitHub Wiki + Issues + Projects | 开源协作标准流程 |

---

## 3. 项目结构设计

采用 **功能模块化 + 核心层分离** 的架构，便于维护与扩展。

---

## 4. 本地存储方案（SQLite + drift）

### 4.1 数据库选型

- 使用 **SQLite** 作为本地持久化存储引擎，无需网络、性能稳定、支持复杂查询。
- 采用 **drift**（原 moor）作为数据库抽象层，提供：
  - Dart 代码定义表结构（类型安全）
  - 自动生成 DAO（数据访问对象）
  - 支持数据库迁移（schema 升级）
  - 支持事务与批处理

### 4.2 数据模型

所有数据模型均以 **实体类 + drift Table 定义** 的方式实现，确保类型安全与一致性。

核心表包括：

- `ledgers`：账本表（名称、币种、创建时间）
- `transactions`：交易表（类型、金额、分类、账户、时间、备注）
- `categories`：分类表（支出/收入类别，支持自定义图标）
- `accounts`：账户表（现金、银行卡、支付宝等）
- `sync_metadata`：同步元数据（最后同步时间、版本号、冲突标记）

### 4.3 数据隔离

- 所有数据通过 `ledgerId` 字段进行账本隔离。
- 用户切换账本时，仅查询对应 `ledgerId` 的数据。

### 4.4 数据迁移

- 使用 drift 的 migration 机制，支持从 v1 → v2 → v3 的平滑升级。
- 每次 schema 变更需新增 migration 脚本，确保老用户数据不丢失。

### 4.5 数据安全（可选）

- 支持本地加密（如使用 `encrypt` 库），对敏感字段（如备注）进行 AES 加密。
- 加密密钥由系统密钥链（iOS Keychain / Android Keystore）管理。

---

## 5. 云同步架构设计（可插拔）

### 5.1 设计目标

- **不依赖任何单一云服务**。
- 支持未来接入多种免费云服务（如 GitHub、Firebase、Supabase、OneDrive、iCloud、WebDAV）。
- 用户可自由选择或切换同步方式。
- 服务失效时，可快速替换为其他适配器。

### 5.2 架构模式：适配器模式（Adapter Pattern）

#### 核心组件

- `SyncAdapter`：抽象接口，定义所有云服务必须实现的方法。
- `SyncService`：同步服务管理器，负责调度、状态维护、冲突检测。
- `adapters/` 目录：存放具体云服务适配器实现。

#### SyncAdapter 接口定义

```dart
Future<void> init();
Future<List<SyncRecord>> pull();
Future<void> push(List<SyncRecord> changes);
Future<SyncStatus> getStatus();
Future<void> logout();

5.3 同步流程
用户在设置中选择同步方式（如 “GitHub Sync”）。
SyncService 加载对应适配器并调用 init()（触发 OAuth 授权）。
首次同步：pull 远程数据 → 合并本地数据 → push 最终状态。
后续同步：定时或手动触发，采用 增量同步 策略。
冲突处理：采用“最后写入优先”或“手动合并”策略（后期可增强）。
5.4 支持的云服务（未来可扩展）
服务 存储方式 授权方式 备注
GitHub Gist / Repo 文件 OAuth 免费、全球可用
Firebase Firestore OAuth 实时同步，免费额度足
Supabase PostgreSQL OAuth 开源替代 Firebase
OneDrive 文件存储 Microsoft OAuth 微软生态友好
WebDAV 文件同步 Basic Auth 支持自建服务器（如 Nextcloud）
5.5 可插拔实现
所有适配器实现 SyncAdapter 接口。
通过工厂模式动态加载。
新增服务只需实现接口并注册，不影响核心逻辑。
6. 数据导入与导出
6.1 导出功能
支持导出为 CSV 格式，兼容 Excel、Numbers、Google Sheets。
可选择导出范围：当前账本 / 所有账本。
导出字段：时间、类型、分类、金额、账户、备注、币种。
导出路径：使用系统文件选择器。
6.2 导入功能
支持从 CSV 文件导入。
自动识别字段映射（支持自定义列映射）。
数据校验：金额格式、时间格式、分类存在性。
导入策略：追加 or 覆盖（用户选择）。
6.3 本地备份
支持生成加密 JSON 备份文件（.beeback 或 .starback）。
可通过文件管理器分享或保存。
7. 多账本与多币种支持
7.1 账本管理
用户可创建多个独立账本（如“个人”、“家庭”、“旅行”）。
每个账本可设置：
名称
币种（CNY、USD、EUR 等 ISO 4217）
创建时间
首页顶部提供账本切换下拉菜单。
7.2 多币种处理
交易金额与账本币种一致。
跨币种转账需手动输入汇率（后期可接入实时汇率 API）。
统计时统一换算为账本币种（汇率取交易日汇率）。
8. 安全与隐私
所有数据默认本地存储，未经用户授权不上传任何信息。
云同步需用户主动开启并授权。
支持本地数据加密（可选功能，使用系统密钥链保护密钥）。
不收集用户行为数据、不嵌入第三方 SDK（如广告、统计）。
9. 可扩展性与未来规划
9.1 插件化设计
预留插件接口，支持：
预算管理插件
定期账单插件
报表生成插件
汇率自动更新插件
9.2 Web 版支持
使用 Flutter Web 编译为 PWA，支持浏览器使用。
数据仍本地存储（IndexedDB），可同步。
9.3 社区贡献
提供清晰的 CONTRIBUTING.md 和 ISSUE_TEMPLATE。
鼓励社区开发新适配器（如 Dropbox、iCloud）。
10. 构建与发布
10.1 构建流程
使用 GitHub Actions 实现 CI/CD：
代码提交 → 自动运行单元测试 + 集成测试
打包 iOS（.ipa）与 Android（.apk/.aab）
发布到 TestFlight / Firebase App Distribution
正式发布通过 App Store / Google Play 手动提交。
10.2 版本管理
采用语义化版本（SemVer）：主版本.次版本.修订号
Git Tag 与发布版本对应。
11. 总结
本技术方案设计了一个高内聚、低耦合、可扩展的开源记账软件架构：

使用 Flutter + drift 实现跨平台与本地存储。
通过 可插拔同步适配器 支持未来接入多种免费云服务，避免 vendor lock-in。
数据模型清晰，支持多账本、多币种、导入导出。
安全优先，用户数据本地为主，云同步可选。
代码结构模块化，便于开源协作与长期维护。
该方案为项目提供了坚实的技术基础，支持从 MVP 快速迭代至功能完整的成熟产品。
